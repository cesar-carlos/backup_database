name: Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Create minimal .env for tests
        run: |
          if [ -f .env.example ]; then
            cp .env.example .env
          else
            echo "APP_NAME=Backup Database" > .env
            echo "SINGLE_INSTANCE_ENABLED=true" >> .env
          fi

      - name: Analyze
        run: flutter analyze --no-fatal-infos

      - name: Run unit tests
        run: flutter test test/unit/ --reporter compact

      - name: Run integration tests (FTP)
        env:
          RUN_FTP_INTEGRATION: "1"
        run: flutter test test/integration/ftp_integration_test.dart --reporter compact

      - name: Run integration tests (File Transfer)
        run: flutter test test/integration/file_transfer_integration_test.dart --reporter compact

      - name: Run integration tests (Socket)
        run: flutter test test/integration/socket_integration_test.dart --reporter compact
